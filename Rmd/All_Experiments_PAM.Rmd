---
title: "Untitled"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# LOAD LIBRARIES # 
```{r}
library(lmerTest)
library(emmeans)
library(sjPlot)
library(drc)
library(Rmisc)
library(ggplot2)
library(tidyr)
library(dplyr)
library(plyr)
library(reshape2)
library(data.table)
```

# IMPORT DATA #
```{r}
IPa <- readxl::read_xlsx("data/PAM/2021-06-08_Past-4temps-Inshore.xlsx")

OPa <- readxl::read_xlsx("data/PAM/2021-06-10_Past-4temps-Offshore.xlsx") %>%
  select(-Temp)

NAc <- readxl::read_xlsx("data/PAM/2021-06-11_Acer-4temps-MoteLooeNursery_Run2.xlsx") %>%
  mutate(TagNumber = Genotype,
         Comments = Comment) %>%
  select(-Comment)

# Combine all Datasets 
Allpam <- rbind(IPa, OPa, NAc) %>%
  mutate(Species = case_when(Species == "Acropora cervicornis" ~ "ACER",
                             Species == "Porites astreoides" ~ "PAST")) %>%
  select(TubeNumber, sample_ID = SampleName, species = Species, Geno = Genotype, Treatment, Temperature = Temp_Setpoint, Timepoint, FvFm = PAM) %>%
  mutate(TP_ID = case_when(grepl("T1", sample_ID) ~ "T1",
                           grepl("T2", sample_ID) ~ "T2",
                           grepl("T3", sample_ID) ~ "T3",
                           grepl("T4", sample_ID) ~ "T4",
                           grepl("T5", sample_ID) ~ "T5",
                           grepl("T0", sample_ID) ~ "T0",
                           grepl("TF", sample_ID) ~ "TF"))


Allpam$FacTemp<-as.factor(Allpam$Temperature)
Allpam$Geno<-as.factor(Allpam$Geno)
Allpam$Temperature<- as.integer(Allpam$Temperature)
Allpam<-as.data.frame(Allpam)
```


```{r}
Acer_T3 <- Allpam %>%
  filter(species == "ACER") %>%
  filter(TP_ID == "T3")

str(Acer_T3)

ACER_DRC <- drm(FvFm ~ Temperature, data = Acer_T3[Acer_T3$species=="ACER",], curveid=Geno, fct = LL.3())
summary(ACER_DRC)
plot(ACER_DRC)

#Run whole population/species instead, pooling all Fv/Fm values across genotypes
ACER_DRC1 <- drm(FvFm ~ Temperature, data = Acer_T3[Acer_T3$species=="ACER",], fct = LL.3())

#extract mean ED50 for the population and compute 95% CIs
ACER_coeff<-data.frame(ED(ACER_DRC1, c(50)))
ACER_coeff_mean<-ACER_coeff[,1]
ACER_coeff_lower<-ACER_coeff[,1] - 1.96*ACER_coeff[,2]
ACER_coeff_upper<-ACER_coeff[,1] + 1.96*ACER_coeff[,2]

Coeff_means<-data.frame(ACER_coeff_mean)
Coeff_lowers<-data.frame(ACER_coeff_lower)
Coeff_uppers<-data.frame(ACER_coeff_upper)

ACER_preddata = data.frame(temp = seq(30,37, length.out = 100))
ACER_pred = as.data.frame(predict(ACER_DRC1, newdata = ACER_preddata, interval = 'confidence'))
ACER_preddata = data.frame(ACER_preddata, fvfm = ACER_pred$Prediction, Lower = ACER_pred$Lower, Upper = ACER_pred$Upper)


ggplot() +
  geom_jitter(data = Acer_T3, aes(x = Temperature, y = FvFm, color = species), size = 1, width = 0.25) +
  scale_x_continuous(limits=c(29,40), breaks=c(30,32,34,36,38)) +
  scale_y_continuous(limits=c(-0.01, 0.75), breaks=c(0, 0.2, 0.4, 0.6)) +
  
  geom_line(data = ACER_preddata, aes(x = temp, y = fvfm), color = 'royalblue2', show.legend = FALSE) +
  geom_ribbon(data = ACER_preddata, aes(x = temp, ymin=Lower, ymax=Upper), color = 'royalblue2', linetype=2, alpha = 
                0.2) +
  geom_vline(data = Coeff_means, aes(xintercept = ACER_coeff_mean), color = 'royalblue2', show.legend = FALSE) +
  annotate("rect", xmin=Coeff_lowers$ACER_coeff_lower, xmax=Coeff_uppers$ACER_coeff_upper, ymin=-Inf, ymax=Inf, fill= 'royalblue2',  alpha = 0.1) +
  geom_text(data = Coeff_means, aes(label=round(ACER_coeff_mean, digits = 2)), x = 31, y = 0.3, show.legend = FALSE, 
            color = 'royalblue2') +
  ggtitle("Fv/Fm ED50 thermal thresholds") +
  scale_color_manual(values=c("royalblue2", "darkgoldenrod1", "darkorange1", "red3", "springgreen1", "purple3")) +
  ylab("Fv/Fm") +
  xlab("Temperature (Â°C)") +
  theme_bw()






ACER_DRC <- drm(FvFm ~ Temperature, data = Acer_T3[Acer_T3$species=="ACER",], curveid=Geno, fct = LL.3())
summary(ACER_DRC)
plot(ACER_DRC)



#extract mean ED50 for the population and compute 95% CIs
ACER_coeff<-data.frame(ED(ACER_DRC, c(50)))
ACER_coeff_mean<-ACER_coeff[,1]
ACER_coeff_lower<-ACER_coeff[,1] - 1.96*ACER_coeff[,2]
ACER_coeff_upper<-ACER_coeff[,1] + 1.96*ACER_coeff[,2]

Coeff_means<-data.frame(ACER_coeff_mean)
Coeff_lowers<-data.frame(ACER_coeff_lower)
Coeff_uppers<-data.frame(ACER_coeff_upper)

ACER_preddata = data.frame(temp = seq(30,37, length.out = 100))
ACER_pred = as.data.frame(predict(ACER_DRC, newdata = ACER_preddata, interval = 'confidence'))
ACER_preddata = data.frame(ACER_preddata, fvfm = ACER_pred$Prediction, Lower = ACER_pred$Lower, Upper = ACER_pred$Upper)


ggplot() +
  geom_jitter(data = Acer_T3, aes(x = Temperature, y = FvFm, color = Geno), size = 1, width = 0.25) +
  scale_x_continuous(limits=c(29,37.5), breaks=c(30,33,35,37)) +
  scale_y_continuous(limits=c(-0.01, 0.75), breaks=c(0, 0.2, 0.4, 0.6)) +

  geom_line(data = ACER_preddata, aes(x = temp, y = fvfm), color = 'royalblue2', show.legend = FALSE) +
  geom_ribbon(data = ACER_preddata, aes(x = temp, ymin=Lower, ymax=Upper), color = 'royalblue2', linetype=2, alpha = 
                0.2) +
  geom_vline(data = Coeff_means, aes(xintercept = ACER_coeff_mean), color = 'royalblue2', show.legend = FALSE) +
  annotate("rect", xmin=Coeff_lowers$ACER_coeff_lower, xmax=Coeff_uppers$ACER_coeff_upper, ymin=-Inf, ymax=Inf, fill= 'royalblue2',  alpha = 0.1) +
  geom_text(data = Coeff_means, aes(label=round(ACER_coeff_mean, digits = 2)), x = 31, y = 0.3, show.legend = FALSE, 
            color = 'royalblue2') +
  ggtitle("Fv/Fm ED50 thermal thresholds") +
  ylab("Fv/Fm") +
  xlab("Temperature (°C)") +
  theme_bw()


  # scale_color_manual(values=c("royalblue2", "darkgoldenrod1", "darkorange1", "red3", "springgreen1", "purple3")




```



























































































# PORITES #
```{r}
PAST <- Allpam %>%
  filter(species == "PAST")

Past_TP <-  PAST %>%
  filter(TubeNumber != "NA") %>%
  select(Geno, Treatment, Temp, TP_ID, FvFm) %>%
  filter(Treatment != "Field", 
         Treatment != "Initial")

ggplot(Past_TP, aes(x = TP_ID, y = FvFm, color = Geno)) +
  geom_point() +
  facet_wrap(~Treatment)

Past_TP$Treatment_f = factor(Past_TP$Treatment, levels=c('Control','Low','Medium','High'))

ggplot(Past_TP, aes(x = TP_ID, y = FvFm, color = Geno)) +
  geom_point() +
  facet_grid(Geno~Treatment_f) +
  theme_bw() +
  theme(legend.position = "none") +
  xlab("Timepoint")

ggsave(filename = "plots/Past_FvFm_Treatment_TP.png", width = 300, height = 250, units = "mm")

x <- Past_TP %>%
  filter(Geno == "06")

DRCpamgeno = drm(FvFm ~ Temp, data = x, curveid = TP_ID,
             fct = LL.3(names = c('hill', 'max', 'ed50')))
summary(DRCpamgeno)
compParm(DRCpamgeno, 'ed50')
compParm(DRCpamgeno, 'ed50', "-")
plot(DRCpamgeno)

ggplot(x, aes(x = Temp, y = FvFm, color = TP_ID)) +
  geom_line()

```

```{r}
Past_T5 <- PAST %>%
  filter(TubeNumber != "NA") %>%
  filter(TP_ID == "T5") %>%
  select(sample_ID, Geno, Treatment, Temp, Timepoint, FvFm)

Past_T5_PAM <- PAST %>%
  filter(TubeNumber == "NA",
         TP_ID == "T5") %>%
  select(sample_ID, Geno, Treatment, Temp, Timepoint, FvFm)

a <- rbind(Past_T5, Past_T5_PAM)

ggplot(a, aes(x = Temp, y = FvFm)) +
  geom_point() +
  facet_grid(Timepoint~Geno)


ggplot(Past, aes(x = Temp, y = FvFm, color = Geno)) +
  geom_point() +
  facet_grid(~Geno) +
  theme_bw() +
  theme(legend.position = "none") +
  xlab("Timepoint")
```

# T1 #
```{r}
T1 <- PAST %>%
  filter(TP_ID == "T1")

DRCpamgeno = drm(FvFm ~ Temp, data = T1, curveid = Geno,
             fct = LL.3(names = c('hill', 'max', 'ed50')))
summary(DRCpamgeno)
compParm(DRCpamgeno, 'ed50')
compParm(DRCpamgeno, 'ed50', "-")
plot(DRCpamgeno)

T1_ED <- ED(DRCpamgeno, c(50), interval = "delta")

T1_df<- as.data.frame(T1_ED) 

T1_ED50 <- setDT(T1_df, keep.rownames = "Geno") %>%
  mutate(Genotype = case_when(grepl(":01", Geno) ~ "01",
                              grepl(":02", Geno) ~ "02",
                              grepl(":03", Geno) ~ "03",
                              grepl(":04", Geno) ~ "04",
                              grepl(":05", Geno) ~ "05",
                              grepl(":06", Geno) ~ "06",
                              grepl(":07", Geno) ~ "07",
                              grepl(":08", Geno) ~ "08",
                              grepl(":09", Geno) ~ "09",
                              grepl(":10", Geno) ~ "10"))
T1_ED50_geno <- T1_ED50 %>%
  select(Genotype, ED50 = Estimate)




```




```{r}
T1 <- PAST %>%
  filter(TP_ID == "T1") %>%
  select(Geno, FvFm, Temp)


demo.LL.3 <- drm(FvFm ~ Temp, data = T1, curveid = Geno,
             fct = LL.3(names = c('hill', 'max', 'ed50')))

demo.fits <- expand.grid(conc=exp(seq(log(1.00e-04), log(1.00e-09), length=100)))

pm <- predict(demo.LL.3, newdata=demo.fits, interval="confidence") 
    demo.fits$p <- pm[,1]
    demo.fits$pmin <- pm[,2]
    demo.fits$pmax <- pm[,3]


demo1$XX <- demo1$X
demo1$XX[demo1$XX == 0] <- 1.00e-09

ggplot(demo1, aes(x = variable, y = value)) +
  geom_point() +
  geom_ribbon(data=demo.fits, aes(x=conc, y=p, ymin=pmin, ymax=pmax), alpha=0.2) +
  geom_line(data=demo.fits, aes(x=conc, y=p)) +
  coord_trans(x="log") 





```















```{r}

Allpam$Temp <- as.character(Allpam$Temp)

ggplot(Allpam, aes(x = Temp, y =FvFm)) +
 geom_violin() 
  

  

```





















# Dose-response curve model fitting
```{r model, results = 'hide'}
# Select whether to use target temp or actual recorded max temp for model fitting
df <- if (temp.adjust) {
  df %>% select(-target_temp)
} else {
  df %>% mutate(max_temp = target_temp) %>% select(-target_temp)
}

# Define function to fit 3-parameter LL model to data and return NULL if fitting error
ll3 <- function(data) {
  drm(fvfm ~ max_temp, data = data, 
      fct = LL.3(names = c("hill", "max", "ED50")),
      upperl = c(120, 0.72, 40),
      lowerl = c(10, 0.55, 30))}
tryll3 <- possibly(ll3, otherwise = NULL)

# Fit model to each coral, get parameters, fitted values, and residuals
initmods <- df %>%
  nest(data = c(max_temp, f, fm, fvfmraw, fvfm, problem)) %>%
  # Fit the model to each coral
  mutate(ll3 = map(data, tryll3)) %>%
  # Get model parameters and fitted values/residuals
  mutate(pars = map(ll3, tidy),
         pred = map2(ll3, data, ~augment(.x, drop_na(.y, fvfm))))

# Extract ed50 parameter values from model fits
ed50 <- initmods %>% 
  select(nursery, geno, pars) %>%
  unnest(pars) %>%
  filter(term == "ED50")

# Collect raw data, fitted values, and diagnostics
vals <- initmods %>%
  select(nursery, geno, pred) %>%
  unnest(pred) %>%
  full_join(ed50) %>%
  full_join(df) %>%
  rename(ed50 = estimate)

# Identify problematic data points based on cook's distance and residuals
counts <- vals %>% 
  group_by(nursery, geno) %>% 
  summarise(n = sum(!is.na(fvfm)))
dff <- vals %>%
  left_join(counts) %>%
  group_by(nursery, geno) %>%
  mutate(resid.thresh = 2*sd(.resid, na.rm = T)) %>%  # Calculate residual threshold as 2 standard deviations
  mutate(cooksd.thresh = 4/n) %>%   # Calculate cook's distance threshold as 4/n
  mutate(max_to_remove = floor(n * 0.2)) %>%
  ungroup() %>%
  mutate(problem = case_when(.cooksd > cooksd.thresh & .resid > 0 ~ "high cook's distance",
                             .resid > resid.thresh ~ "high residual", 
                             TRUE ~ problem)) %>%
  group_by(nursery, geno, outlier = problem %in% c("high cook's distance", "high residual")) %>%
  mutate(n.outliers = n(),
         rank.out = order(.cooksd, decreasing = TRUE)) %>%
  ungroup() %>%
  mutate(fvfm = case_when(outlier & rank.out <= max_to_remove ~ NA_real_, 
                          TRUE ~ fvfm)) 


# Refit models without problematic points
fmods <- dff %>%
  select(nursery, geno, max_temp, f, fm, fvfmraw, problem, fvfm) %>%
  nest(data = c(max_temp, f, fm, fvfmraw, fvfm, problem)) %>%
  # Fit the model to each coral
  mutate(ll3 = map(data, tryll3)) %>%
  # Get model parameters and fitted values/residuals
  mutate(pars = map(ll3, tidy),
         pred = map2(ll3, data, ~augment(.x, drop_na(.y, fvfm))))

# Extract ed50 parameter values from model fits
fed50 <- fmods %>% 
  select(nursery, geno, pars) %>%
  unnest(pars) %>%
  filter(term == "ED50")

# Collect raw data, fitted values, and ed50 estimates
fvals <- fmods %>%
  select(nursery, geno, pred) %>%
  unnest(pred) %>%
  full_join(fed50) %>%
  full_join(select(dff, nursery, geno, max_temp, f, fm, fvfmraw, problem, fvfm)) %>%
  rename(ed50 = estimate)
```











```{r}

str(Full_PAM)

ACER_DRC <- drm(FvFm ~ Temperature, data = Full_PAM[Full_PAM$species=="ACER",], curveid=sample_ID, fct = LL.3())


summary(ACER_DRC)
plot(ACER_DRC)
```

























# IMPORT DATA #
```{r}


Full_PAM$species<-as.factor(Full_PAM$species)
Full_PAM$Timepoint<-as.factor(Full_PAM$Timepoint)
Full_PAM$Genotype<-as.factor(Full_PAM$Genotype)
Full_PAM$Location<-as.factor(Full_PAM$Location)
Full_PAM$Temperature<-as.numeric(Full_PAM$Temperature)
Full_PAM$sample_ID<-as.factor(Full_PAM$sample_ID)


# Inshore Past
InshorePa <-read.delim("data/PAM/2021-06-08_CarlysInshore_Past_RNASeq.txt")

IPa <- InshorePa %>%
  gather(key = "Tp", value = FvFm, -SampleName, -species, -Tank, -Temp, -Geno, -Timepoint) %>%
  filter(!is.na(FvFm)) %>%
  select(species, sample_ID = SampleName, Tank, Temperature = Temp, Timepoint, FvFm) %>%
  mutate(replicate = case_when(Tank == 1 ~ "C",
                               Tank == 2 ~ "L",
                               Tank == 3 ~ "M",
                               Tank == 4 ~ "H"))
# Offshore Past 
OffshorePa <- read.delim("data/PAM/2021-06-10_CarlysOffshore_Past_RNASeq.txt") %>%
  select(-Start.EndTimes, -X, -X.1, -Tank.1, -Time.on.Spec, -Record, -PAR)





```

